import type { VercelRequest, VercelResponse } from '@vercel/node'
import { ImageResponse } from '@vercel/og'
// biome-ignore lint/correctness/noUnusedImports: React is required for JSX
import React from 'react'

interface VaultData {
  name: string
  symbol: string
  token: {
    symbol: string
  }
  apr: {
    netAPR: number
    forwardAPR: {
      netAPR: number
    }
  }
  tvl: {
    tvl: number
  }
  chainID: number
}

const Logo = () => (
  <svg width="400" height="41" viewBox="0 0 300 31" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g clipPath="url(#clip0_4029_812)">
      <path
        d="M-0.00130166 5.64568C-0.0119075 4.98978 0.10708 4.33843 0.348587 3.73033C0.590093 3.12223 0.949186 2.56983 1.4045 2.10598C1.85982 1.64212 2.40206 1.27626 2.99896 1.03022C3.59587 0.784187 4.23525 0.662984 4.87908 0.673789C5.52296 0.662742 6.16245 0.783806 6.75947 1.02976C7.35648 1.27571 7.89882 1.64152 8.35418 2.10542C8.80954 2.56933 9.16862 3.12182 9.41005 3.73004C9.65147 4.33825 9.7703 4.98972 9.75945 5.64568C9.77006 6.3015 9.65107 6.95281 9.40954 7.56082C9.16802 8.16883 8.80889 8.72112 8.35356 9.18484C7.89822 9.64856 7.35596 10.0142 6.75906 10.2601C6.16216 10.5059 5.52282 10.6269 4.87908 10.6159C4.2354 10.6267 3.59616 10.5055 2.99936 10.2596C2.40257 10.0136 1.86041 9.64798 1.40512 9.18431C0.949829 8.72064 0.590707 8.16842 0.349097 7.56052C0.107486 6.95262 -0.0116764 6.30144 -0.00130166 5.64568V5.64568Z"
        fill="white"
      />
      <path
        d="M13.832 28.0384V20.4728H14.6846C15.66 26.0493 18.3338 28.7732 22.8323 28.7732C26.3962 28.7732 28.7289 26.9127 28.7289 23.6276C28.7289 20.0837 26.0142 18.8294 21.8552 17.1877C18.0371 15.6746 14.0486 14.2049 14.0486 9.19654C14.0486 4.4852 17.5273 1.11328 23.383 1.11328C26.947 1.11328 29.0274 2.10696 31.6995 2.8418V10.1902H30.8468C29.955 5.30692 27.2812 2.8418 23.0386 2.8418C19.8992 2.8418 17.9468 4.44176 17.9468 7.3377C17.9468 9.88794 19.432 11.1422 24.0992 12.9576C28.555 14.7296 32.8829 16.3296 32.8829 21.8174C32.8829 27.135 28.937 30.5035 22.8698 30.5035C18.0729 30.5018 15.8698 28.8584 13.832 28.0384Z"
        fill="white"
      />
      <path
        d="M46.5924 26.8276C48.7563 26.8276 50.7071 26.1779 52.2776 24.9688L52.8284 25.5733C51.6842 27.043 49.053 30.5018 44.5546 30.5018C39.2087 30.5018 35.4316 26.3516 35.4316 20.4729C35.4316 15.025 38.9956 10.1833 44.512 10.1833C49.3071 10.1833 52.235 13.729 51.8104 18.9598H39.2923V19.2186C39.2923 23.758 41.8808 26.8276 46.5924 26.8276ZM47.9566 17.2295C48.0845 14.1181 46.8107 11.9136 44.3074 11.9136C41.8877 11.9136 40.0221 13.9878 39.4696 17.2295H47.9566Z"
        fill="white"
      />
      <path
        d="M64.5815 10.1833C68.0192 10.1833 70.2258 11.5245 70.2258 13.8159C70.2263 14.1849 70.1552 14.5504 70.0168 14.8914C69.8784 15.2324 69.6753 15.5423 69.4192 15.8032C69.1631 16.0641 68.8589 16.271 68.5242 16.4121C68.1894 16.5531 67.8307 16.6254 67.4684 16.6249C65.6848 16.6249 64.7094 15.1987 64.7094 13.8159C64.7059 13.4797 64.7678 13.1462 64.8916 12.8346C65.0154 12.523 65.1987 12.2395 65.4307 12.0005C65.0566 11.9026 64.6707 11.8599 64.2848 11.8737C60.7208 11.8737 58.429 15.2022 58.429 19.3437C58.429 23.9265 61.2307 26.8137 65.7274 26.8137C67.8913 26.8137 69.8438 26.164 71.4144 24.9549L71.9651 25.5595C70.8192 27.0291 68.1898 30.4879 63.6914 30.4879C58.3455 30.4879 54.5684 26.3377 54.5684 20.459C54.565 14.5507 58.6848 10.1833 64.5815 10.1833Z"
        fill="white"
      />
      <path
        d="M75.8279 23.9317V17.0575C75.8279 15.1118 74.7673 13.6421 72.8574 13.3833V12.5147C75.1018 11.989 77.3012 11.2808 79.4345 10.397L79.646 10.5256V22.9328C79.646 25.8287 80.8771 27.4287 83.0411 27.4287C84.9168 27.4287 86.4362 26.1744 87.7083 24.1871V17.054C87.7083 15.1084 86.6476 13.6387 84.7378 13.3798V12.5112C86.9822 11.9858 89.1817 11.2776 91.3149 10.3936L91.528 10.5221V23.6642C91.528 25.6098 92.5887 27.0795 94.4985 27.3384V28.207C92.2541 28.7324 90.0546 29.4406 87.9214 30.3246L87.7083 30.1961V26.5636H87.4968C86.0969 29.4613 83.5919 30.4984 81.4279 30.4984C78.1181 30.5018 75.8279 27.7779 75.8279 23.9317Z"
        fill="white"
      />
      <path
        d="M96.6211 29.2042C98.531 28.9453 99.5916 27.4669 99.5916 25.5299V17.0575C99.5916 15.1118 98.531 13.6422 96.6211 13.3833V12.5147C98.8655 11.989 101.065 11.2809 103.198 10.397L103.41 10.5256V25.5265C103.41 27.4721 104.472 28.9418 106.805 29.2007V30.0693H96.6211V29.2042ZM105.318 12.9942C105.317 12.6249 105.388 12.2591 105.526 11.9177C105.665 11.5764 105.868 11.2663 106.124 11.0051C106.381 10.744 106.685 10.5369 107.02 10.3959C107.355 10.2549 107.714 10.1827 108.077 10.1834C108.44 10.182 108.799 10.2537 109.135 10.3945C109.47 10.5352 109.775 10.7421 110.032 11.0034C110.289 11.2646 110.492 11.575 110.631 11.9166C110.769 12.2583 110.84 12.6245 110.839 12.9942C110.84 13.3633 110.77 13.729 110.631 14.0703C110.493 14.4115 110.29 14.7215 110.034 14.9825C109.778 15.2436 109.473 15.4505 109.138 15.5913C108.803 15.7321 108.444 15.8042 108.082 15.8033C107.719 15.8046 107.36 15.733 107.024 15.5923C106.689 15.4517 106.384 15.2449 106.127 14.9839C105.871 14.7228 105.667 14.4127 105.528 14.0712C105.39 13.7297 105.319 13.3637 105.319 12.9942H105.318Z"
        fill="white"
      />
      <path
        d="M123.481 26.8276C125.645 26.8276 127.596 26.1779 129.166 24.9688L129.719 25.5733C128.573 27.043 125.942 30.5018 121.443 30.5018C116.097 30.5018 112.32 26.3516 112.32 20.4729C112.32 15.025 115.886 10.1833 121.401 10.1833C126.196 10.1833 129.124 13.729 128.699 18.9598H116.183V19.2186C116.183 23.758 118.771 26.8276 123.481 26.8276ZM124.845 17.2295C124.973 14.1181 123.699 11.9136 121.196 11.9136C118.778 11.9136 116.911 13.9878 116.358 17.2295H124.845Z"
        fill="white"
      />
      <path
        d="M131.883 21.0808C131.883 14.813 136.168 10.1868 141.471 10.1868C143.017 10.1644 144.536 10.6001 145.844 11.441V7.16223C145.844 5.21655 144.781 3.74688 142.873 3.4863V2.61769C145.117 2.09067 147.317 1.38196 149.45 0.498291L149.662 0.628582V23.6693C149.662 25.615 150.722 27.0847 152.632 27.3435V28.2121C150.388 28.7378 148.188 29.446 146.055 30.3298L145.844 30.2012V26.5687H145.625C144.432 29.2492 141.976 30.5035 139.558 30.5035C135.447 30.5018 131.883 26.7841 131.883 21.0808ZM141.048 27.4356C142.745 27.4356 144.527 26.4853 145.844 24.1939V13.2495C144.866 12.3809 143.298 11.9101 141.939 11.9101C138.842 11.9101 135.658 14.5906 135.658 20.0368C135.658 24.7516 138.035 27.4321 141.048 27.4321V27.4356Z"
        fill="white"
      />
      <path
        d="M165.787 24.6665V6.94691C165.787 4.78581 164.216 3.09899 161.967 2.84015V1.54419H183.608V10.1886H182.755C182.205 5.56411 180.506 3.27271 176.985 3.27271H170.029V15.2039L175.164 15.1605C178.049 15.1605 179.705 13.6474 179.916 10.8383H180.769V21.213H179.916C179.705 18.4021 178.04 16.889 175.164 16.889L170.029 16.9324V24.2392C170.029 26.7894 171.6 28.6483 174.272 28.7351V30.0745H161.967V28.7247C164.213 28.5127 165.787 26.7842 165.787 24.6665Z"
        fill="white"
      />
      <path
        d="M188.615 25.5298V17.0574C188.615 15.1117 187.554 13.642 185.645 13.3832V12.5146C187.889 11.9891 190.088 11.281 192.222 10.3969L192.435 10.5255V25.5263C192.435 27.472 193.495 28.9417 195.405 29.2005V30.0691H185.645V29.2005C187.554 28.9452 188.615 27.4755 188.615 25.5298ZM190.271 1.53883C190.633 1.53769 190.993 1.60954 191.328 1.75026C191.663 1.89098 191.968 2.09781 192.224 2.35884C192.481 2.61987 192.684 2.92995 192.823 3.2713C192.961 3.61265 193.032 3.97852 193.032 4.3479C193.032 4.71707 192.961 5.08277 192.823 5.42399C192.685 5.76521 192.482 6.07524 192.226 6.33637C191.969 6.59749 191.665 6.80455 191.33 6.94567C190.996 7.08678 190.637 7.1592 190.274 7.15875C189.912 7.15943 189.553 7.08719 189.218 6.94617C188.883 6.80516 188.578 6.59815 188.322 6.337C188.065 6.07586 187.862 5.7657 187.724 5.42437C187.585 5.08304 187.515 4.71721 187.515 4.3479C187.515 3.97896 187.585 3.61354 187.724 3.27253C187.862 2.93152 188.065 2.62162 188.321 2.36066C188.577 2.0997 188.881 1.89277 189.215 1.75174C189.55 1.61071 189.909 1.53837 190.271 1.53883V1.53883Z"
        fill="white"
      />
      <path
        d="M212.165 25.5298V17.7488C212.165 14.8528 210.934 13.2528 208.77 13.2528C206.903 13.2528 205.375 14.5071 204.103 16.4945V25.528C204.103 27.4737 205.163 28.9434 206.649 29.2022V30.0709H197.312V29.2022C199.222 28.9434 200.283 27.465 200.283 25.528V17.0556C200.283 15.1099 199.222 13.6403 197.312 13.3814V12.5128C199.557 11.9871 201.756 11.2789 203.89 10.3951L204.103 10.5237V14.1128H204.314C205.714 11.2168 208.217 10.178 210.383 10.178C213.691 10.178 215.983 12.9019 215.983 16.7499V25.5245C215.983 27.6856 216.747 28.5942 218.954 29.1988V30.0674H209.619V29.1988C211.447 28.5994 212.165 27.6909 212.165 25.5298Z"
        fill="white"
      />
      <path
        d="M220.947 25.4012C220.947 22.5904 222.9 20.775 227.144 19.4773L231.641 18.0876V17.655C231.641 14.6288 230.326 13.1591 227.695 13.1591C225.574 13.1591 223.875 14.0676 222.051 15.711L221.5 15.1048C222.646 13.6351 225.403 10.1763 229.562 10.1763C233.126 10.1763 235.46 12.7283 235.46 16.7482V26.7337C235.46 27.684 235.928 28.1599 236.521 28.1599C237.101 28.1386 237.661 27.9434 238.133 27.5988L238.644 28.2468C237.451 29.6366 236.184 30.4079 234.656 30.4079C233.17 30.4079 231.642 29.6296 231.642 27.0794V26.5582H231.431C230.237 29.1953 228.247 30.493 225.957 30.493C222.9 30.5017 220.947 28.2538 220.947 25.4012ZM227.306 27.3018C228.706 27.3018 230.404 26.3081 231.634 24.1904V19.691L228.58 20.6847C225.567 21.6801 224.76 23.1498 224.76 24.5761C224.767 26.2646 225.913 27.3018 227.306 27.3018Z"
        fill="white"
      />
      <path
        d="M255.192 25.5299V17.7489C255.192 14.853 253.961 13.253 251.797 13.253C249.922 13.253 248.402 14.5073 247.13 16.4947V25.5282C247.13 27.4739 248.191 28.9435 249.676 29.2024V30.071H240.34V29.2024C242.25 28.9435 243.31 27.4652 243.31 25.5282V17.0558C243.31 15.1101 242.25 13.6404 240.34 13.3816V12.513C242.584 11.9892 244.784 11.2828 246.917 10.4005L247.13 10.5291V14.1181H247.342C248.742 11.2222 251.247 10.1833 253.41 10.1833C256.72 10.1833 259.01 12.9073 259.01 16.7552V25.5299C259.01 27.691 259.774 28.5996 261.981 29.2041V30.0727H252.647V29.2041C254.471 28.5996 255.192 27.691 255.192 25.5299Z"
        fill="white"
      />
      <path
        d="M273.734 10.1833C277.172 10.1833 279.378 11.5245 279.378 13.8159C279.379 14.185 279.308 14.5507 279.169 14.8918C279.03 15.2329 278.827 15.5429 278.571 15.8038C278.315 16.0648 278.01 16.2716 277.675 16.4125C277.34 16.5534 276.981 16.6256 276.619 16.6249C274.837 16.6249 273.862 15.1987 273.862 13.8159C273.858 13.4797 273.92 13.1462 274.044 12.8346C274.168 12.523 274.351 12.2395 274.583 12.0005C274.209 11.9014 273.823 11.8576 273.437 11.8702C269.873 11.8702 267.581 15.1987 267.581 19.3402C267.581 23.923 270.381 26.8102 274.88 26.8102C277.044 26.8102 278.996 26.1605 280.567 24.9514L281.117 25.556C279.972 27.0257 277.34 30.4845 272.844 30.4845C267.496 30.4845 263.721 26.3343 263.721 20.4555C263.721 14.5507 267.835 10.1833 273.734 10.1833Z"
        fill="white"
      />
      <path
        d="M293.763 26.8276C295.926 26.8276 297.879 26.1779 299.449 24.9688L300 25.5733C298.854 27.043 296.223 30.5018 291.727 30.5018C286.379 30.5018 282.604 26.3516 282.604 20.4729C282.604 15.025 286.167 10.1833 291.684 10.1833C296.479 10.1833 299.407 13.729 298.982 18.9598H286.464V19.2186C286.464 23.758 289.053 26.8276 293.763 26.8276ZM295.127 17.2295C295.255 14.1181 293.983 11.9136 291.478 11.9136C289.06 11.9136 287.192 13.9878 286.641 17.2295H295.127Z"
        fill="white"
      />
    </g>
    <defs>
      <clipPath id="clip0_4029_812">
        <rect width="300" height="30" fill="white" transform="translate(0 0.5)" />
      </clipPath>
    </defs>
  </svg>
)

function formatAPR(apr: number): string {
  return (apr * 100).toFixed(2)
}

function formatTVL(tvl: number): string {
  if (tvl >= 1_000_000) {
    return `$${(tvl / 1_000_000).toFixed(2)}M`
  }
  if (tvl >= 1_000) {
    return `$${(tvl / 1_000).toFixed(2)}K`
  }
  return `$${tvl.toFixed(2)}`
}

function getChainName(chainId: number): string {
  const chains: Record<number, string> = {
    1: 'Ethereum',
    10: 'Optimism',
    137: 'Polygon',
    250: 'Fantom',
    8453: 'Base',
    42161: 'Arbitrum',
    314: 'Filecoin'
  }
  return chains[chainId] || `Chain ${chainId}`
}

async function fetchVaultData(chainId: string, address: string): Promise<VaultData | null> {
  const baseUri =
    process.env.YDAEMON_BASE_URI || process.env.VITE_YDAEMON_BASE_URI || 'https://vault-api.secured.finance'
  const url = `${baseUri}/${chainId}/vaults/${address}`

  try {
    const response = await fetch(url, {
      headers: {
        Accept: 'application/json'
      }
    })

    if (!response.ok) {
      console.error(`Failed to fetch vault data: ${response.status}`)
      return null
    }

    const data = await response.json()
    return data as VaultData
  } catch (error) {
    console.error('Error fetching vault data:', error)
    return null
  }
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    const { chainId, address } = req.query

    if (typeof chainId !== 'string' || typeof address !== 'string' || !chainId || !address) {
      return res.status(400).json({ error: 'Invalid parameters' })
    }

    const vaultData = await fetchVaultData(chainId, address)

    if (!vaultData) {
      const errorImage = new ImageResponse(
        <div
          style={{
            height: '100%',
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            backgroundColor: '#1a1a1a',
            fontSize: 40,
            fontWeight: 600,
            color: 'white'
          }}
        >
          Vault not found
        </div>,
        {
          width: 1200,
          height: 630
        }
      )

      const buffer = await errorImage.arrayBuffer()
      res.setHeader('Content-Type', 'image/png')
      res.setHeader('Cache-Control', 'public, max-age=31536000, immutable')
      return res.send(Buffer.from(buffer))
    }

    const estAPR = vaultData.apr.forwardAPR.netAPR || 0
    const histAPR = vaultData.apr.netAPR || 0
    const tvl = vaultData.tvl.tvl || 0
    const chainName = getChainName(vaultData.chainID)

    const image = new ImageResponse(
      <div
        style={{
          height: '100%',
          width: '100%',
          display: 'flex',
          flexDirection: 'column',
          backgroundColor: '#00202e',
          padding: '60px 80px'
        }}
      >
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            marginBottom: '20px'
          }}
        >
          <Logo />
        </div>

        <div
          style={{
            fontSize: 20,
            color: '#666',
            display: 'flex',
            alignItems: 'center',
            marginBottom: '40px'
          }}
        >
          {chainName} | {address.slice(0, 8)}...{address.slice(-4)}
        </div>

        <div
          style={{
            fontSize: 56,
            fontWeight: 700,
            color: '#f5f5f5',
            marginBottom: '20px',
            lineHeight: 1.2,
            maxWidth: '900px',
            display: 'flex'
          }}
        >
          {vaultData.name}
        </div>

        <div
          style={{
            display: 'flex',
            gap: '60px'
          }}
        >
          <div
            style={{
              display: 'flex',
              flexDirection: 'column'
            }}
          >
            <div
              style={{
                fontSize: 20,
                color: '#999',
                marginBottom: '10px',
                display: 'flex'
              }}
            >
              Estimated APY
            </div>
            <div
              style={{
                fontSize: 48,
                fontWeight: 700,
                color: '#f5f5f5',
                display: 'flex'
              }}
            >
              {formatAPR(estAPR)}%
            </div>
          </div>

          <div
            style={{
              display: 'flex',
              flexDirection: 'column'
            }}
          >
            <div
              style={{
                fontSize: 20,
                color: '#999',
                marginBottom: '10px',
                display: 'flex'
              }}
            >
              Historical APY
            </div>
            <div
              style={{
                fontSize: 48,
                fontWeight: 700,
                color: '#f5f5f5',
                display: 'flex'
              }}
            >
              {formatAPR(histAPR)}%
            </div>
          </div>

          <div
            style={{
              display: 'flex',
              flexDirection: 'column'
            }}
          >
            <div
              style={{
                fontSize: 20,
                color: '#999',
                marginBottom: '10px',
                display: 'flex'
              }}
            >
              Vault TVL
            </div>
            <div
              style={{
                fontSize: 48,
                fontWeight: 700,
                color: '#f5f5f5',
                display: 'flex'
              }}
            >
              {formatTVL(tvl)}
            </div>
          </div>
        </div>
      </div>,
      {
        width: 1200,
        height: 630
      }
    )

    const buffer = await image.arrayBuffer()
    res.setHeader('Content-Type', 'image/png')
    res.setHeader('Cache-Control', 'public, max-age=31536000, immutable')
    return res.send(Buffer.from(buffer))
  } catch (error) {
    console.error('Error generating OG image:', error)
    return res.status(500).json({ error: 'Failed to generate image', details: String(error) })
  }
}
